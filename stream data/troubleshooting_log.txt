# Azure Functions BigQuery â†’ CosmosDB ëª¨ë“ˆí™” íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ë¡œê·¸

## Metadata
- Timestamp: 2024-12-19 15:30:00 KST
- Severity: Low
- Impacted Systems: storeToCosmos Azure Function
- Tags: ëª¨ë“ˆí™”, Azure Functions, BigQuery, CosmosDB, ì½”ë“œ ë¦¬íŒ©í† ë§

## Problem Summary
ê¸°ì¡´ Azure Functions ì½”ë“œê°€ ë‹¨ì¼ íŒŒì¼(247ì¤„)ì— ëª¨ë“  ë¡œì§ì´ ì§‘ì¤‘ë˜ì–´ ìˆì–´ ìœ ì§€ë³´ìˆ˜ì™€ í™•ì¥ì„±ì´ ì–´ë ¤ìš´ ìƒí™©ì´ì—ˆìŠµë‹ˆë‹¤. ì½”ë“œì˜ ê°€ë…ì„±ê³¼ ì¬ì‚¬ìš©ì„±ì„ ê°œì„ í•˜ê¸° ìœ„í•´ ëª¨ë“ˆí™”ê°€ í•„ìš”í–ˆìŠµë‹ˆë‹¤.

## Root Cause
- ë‹¨ì¼ íŒŒì¼ì— ëª¨ë“  ê¸°ëŠ¥ì´ ì§‘ì¤‘ë˜ì–´ ì½”ë“œ ë³µì¡ë„ê°€ ë†’ìŒ
- ì„¤ì •, í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”, ì¿¼ë¦¬, ë°ì´í„° ì²˜ë¦¬ ë¡œì§ì´ ë¶„ë¦¬ë˜ì§€ ì•ŠìŒ
- í…ŒìŠ¤íŠ¸ì™€ ë””ë²„ê¹…ì´ ì–´ë ¤ìš´ êµ¬ì¡°
- ìƒˆë¡œìš´ ê¸°ëŠ¥ ì¶”ê°€ ì‹œ ê¸°ì¡´ ì½”ë“œ ìˆ˜ì •ì´ í•„ìš”

## Resolution Steps
1. **ì„¤ì • ë¶„ë¦¬**: `config.py` ëª¨ë“ˆ ìƒì„±ìœ¼ë¡œ í™˜ê²½ ë³€ìˆ˜ì™€ ì„¤ì • ê´€ë¦¬
2. **í´ë¼ì´ì–¸íŠ¸ ê´€ë¦¬**: `clients.py`ì— `ClientManager` í´ë˜ìŠ¤ë¡œ BigQuery/CosmosDB í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
3. **ì¿¼ë¦¬ ê´€ë¦¬**: `queries.py`ì— `BigQueryQueries` í´ë˜ìŠ¤ë¡œ ì¿¼ë¦¬ ì •ì˜
4. **ë°ì´í„° ì²˜ë¦¬**: `data_processors.py`ì— `DataProcessor` í´ë˜ìŠ¤ë¡œ ë°ì´í„° ë³€í™˜ ë¡œì§
5. **ëª¨ë¸ ì •ì˜**: `models.py`ì— dataclassë¥¼ ì‚¬ìš©í•œ ë°ì´í„° ëª¨ë¸ ì •ì˜
6. **ìœ í‹¸ë¦¬í‹°**: `utils.py`ì— ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§, ì—ëŸ¬ ì²˜ë¦¬, ë¡œê¹… ìœ í‹¸ë¦¬í‹°
7. **ë©”ì¸ í•¨ìˆ˜ ê°„ì†Œí™”**: `__init__.py`ë¥¼ 35ì¤„ë¡œ ê°„ì†Œí™”
8. **ì‹œê°„ëŒ€ ì˜¤ë¥˜ ìˆ˜ì •**: `time_utils.py`ì—ì„œ pytz ì‚¬ìš©ìœ¼ë¡œ UTC ì‹œê°„ëŒ€ ì˜¤ë¥˜ í•´ê²°
9. **ì•ˆì „í•œ ì†ì„± ì ‘ê·¼**: ëª¨ë“  row ì†ì„± ì ‘ê·¼ì„ getattr()ë¡œ ì•ˆì „í•˜ê²Œ ë³€ê²½í•˜ì—¬ AttributeError ë°©ì§€
10. **í™˜ê²½ ë³€ìˆ˜ ê²€ì¦**: config.pyì— í™˜ê²½ ë³€ìˆ˜ ê²€ì¦ ë¡œì§ ì¶”ê°€
11. **ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”**: ê°œë³„ í–‰ ì²˜ë¦¬ ì˜¤ë¥˜ ì‹œì—ë„ ì „ì²´ í”„ë¡œì„¸ìŠ¤ ê³„ì† ì§„í–‰
12. **BigQuery Iterator ì˜¤ë¥˜ ìˆ˜ì •**: RowIterator ì¤‘ë³µ ìˆœíšŒ ë¬¸ì œ í•´ê²°

## Error Message / Logs
**ë°œê²¬ëœ ì˜¤ë¥˜ 1:**
```
'No time zone found with key UTC'
í–‰ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ (visitorId: 64ff6c97-a13a-4442-816d-0e29a23095b1): 'No time zone found with key UTC'
```

**ë°œê²¬ëœ ì˜¤ë¥˜ 2:**
```
('Iterator has already started', <google.cloud.bigquery.table.RowIterator object at 0x00000161A40FAC10>)
```

**í•´ê²° ë°©ë²•:**
1. time_utils.pyì—ì„œ zoneinfo ëŒ€ì‹  pytz ì‚¬ìš©
2. requirements.txtì— pytz íŒ¨í‚¤ì§€ ì¶”ê°€
3. ëª¨ë“  row ì†ì„± ì ‘ê·¼ì„ getattr()ë¡œ ì•ˆì „í•˜ê²Œ ë³€ê²½
4. BigQuery RowIterator ì¤‘ë³µ ìˆœíšŒ ë¬¸ì œ í•´ê²° (len(list(rows)) ì œê±°)

**ê¸°ì¡´ ì½”ë“œ êµ¬ì¡°:**
```python
# 247ì¤„ì˜ ë‹¨ì¼ íŒŒì¼
import os, logging, json, uuid, azure.functions as func
from google.cloud import bigquery
from google.oauth2 import service_account
from azure.cosmos import CosmosClient, PartitionKey
# ... ëª¨ë“  ë¡œì§ì´ í•˜ë‚˜ì˜ íŒŒì¼ì— ì§‘ì¤‘
```

**ëª¨ë“ˆí™” í›„ êµ¬ì¡°:**
```python
# __init__.py (35ì¤„)
from .clients import client_manager
from .queries import BigQueryQueries
from .data_processors import DataProcessor
# ê¹”ë”í•œ ë©”ì¸ í•¨ìˆ˜
```

## Related Commits or Pull Requests
- ëª¨ë“ˆí™” ì‘ì—…: 8ê°œ íŒŒì¼ ìƒì„± (config.py, clients.py, queries.py, data_processors.py, models.py, utils.py, README.md)
- ê¸°ì¡´ __init__.py íŒŒì¼ ë¦¬íŒ©í† ë§

## Reproduction Steps
1. ê¸°ì¡´ ë‹¨ì¼ íŒŒì¼ êµ¬ì¡° í™•ì¸
2. ê° ê¸°ëŠ¥ë³„ë¡œ ëª¨ë“ˆ ë¶„ë¦¬ ê³„íš ìˆ˜ë¦½
3. ì˜ì¡´ì„± ê´€ê³„ ë¶„ì„ í›„ ëª¨ë“ˆ ìƒì„± ìˆœì„œ ê²°ì •
4. ê° ëª¨ë“ˆë³„ í´ë˜ìŠ¤ ë° í•¨ìˆ˜ ì •ì˜
5. ë©”ì¸ í•¨ìˆ˜ì—ì„œ ëª¨ë“ˆ importí•˜ì—¬ ì‚¬ìš©

## Prevention / Lessons Learned
- Azure Functionsì—ì„œë„ ëª¨ë“ˆí™”ê°€ ê°€ëŠ¥í•˜ê³  ê¶Œì¥ë¨
- ì„¤ì •ê³¼ ë¡œì§ì„ ë¶„ë¦¬í•˜ë©´ í™˜ê²½ë³„ ë°°í¬ê°€ ìš©ì´
- í´ë˜ìŠ¤ ê¸°ë°˜ êµ¬ì¡°ë¡œ í…ŒìŠ¤íŠ¸ ì‘ì„±ì´ ì‰¬ì›Œì§
- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ë¶„ë¦¬ë¡œ ì½”ë“œ ì¬ì‚¬ìš©ì„± í–¥ìƒ
- README ì‘ì„±ìœ¼ë¡œ í”„ë¡œì íŠ¸ ì´í•´ë„ ì¦ëŒ€

## Related Links
- Azure Functions Python ê°œë°œ ê°€ì´ë“œ
- Google Cloud BigQuery Python í´ë¼ì´ì–¸íŠ¸ ë¬¸ì„œ
- Azure CosmosDB Python SDK ë¬¸ì„œ

---

## Metadata
- Timestamp: 2024-12-19 16:45:00 KST
- Severity: Critical
- Impacted Systems: GitHub Repository, Git Push Process
- Tags: ë³´ì•ˆ, GitHub, ì„œë¹„ìŠ¤ ê³„ì • í‚¤, í‘¸ì‹œ ë³´í˜¸

## Problem Summary
GitHubì— ì½”ë“œë¥¼ í‘¸ì‹œí•  ë•Œ ì„œë¹„ìŠ¤ ê³„ì • í‚¤ íŒŒì¼(service_account_key.json)ì´ ë³´ì•ˆ ìœ„ë°˜ìœ¼ë¡œ ê°ì§€ë˜ì–´ í‘¸ì‹œê°€ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. GitHubì˜ Push Protection ê¸°ëŠ¥ì´ Google Cloud ì„œë¹„ìŠ¤ ê³„ì • ìê²© ì¦ëª…ì„ ê°ì§€í•˜ì—¬ í‘¸ì‹œë¥¼ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤.

## Root Cause
- ì„œë¹„ìŠ¤ ê³„ì • í‚¤ íŒŒì¼ì´ Git ì €ì¥ì†Œì— í¬í•¨ë˜ì–´ ì»¤ë°‹ë¨
- GitHubì˜ ìë™ ë³´ì•ˆ ìŠ¤ìº”ì´ ë¯¼ê°í•œ ìê²© ì¦ëª…ì„ ê°ì§€
- .gitignoreì— íŒŒì¼ì´ ì¶”ê°€ë˜ì—ˆì§€ë§Œ ì´ë¯¸ ì»¤ë°‹ íˆìŠ¤í† ë¦¬ì— í¬í•¨ëœ ìƒíƒœ
- Push Protectionì´ í™œì„±í™”ë˜ì–´ ìˆì–´ ë³´ì•ˆ ìœ„ë°˜ ì‹œ í‘¸ì‹œ ì°¨ë‹¨

## Resolution Steps
1. **íŒŒì¼ ì¶”ì  ì œê±°**: `git rm --cached service_account_key.json`ë¡œ Git ì¶”ì ì—ì„œ ì œê±°
2. **ì»¤ë°‹ íˆìŠ¤í† ë¦¬ ì •ë¦¬**: `git filter-branch`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì»¤ë°‹ íˆìŠ¤í† ë¦¬ì—ì„œ ë¯¼ê°í•œ íŒŒì¼ ì™„ì „ ì œê±°
3. **ê°•ì œ í‘¸ì‹œ**: `git push --force`ë¡œ ì •ë¦¬ëœ íˆìŠ¤í† ë¦¬ë¡œ ì›ê²© ì €ì¥ì†Œ ì—…ë°ì´íŠ¸
4. **ë³´ì•ˆ í™•ì¸**: GitHubì—ì„œ ë³´ì•ˆ ìœ„ë°˜ í•´ì œ í™•ì¸

## Error Message / Logs
```
remote: error: GH013: Repository rule violations found for refs/heads/main.
remote: 
remote: - GITHUB PUSH PROTECTION
remote:   â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
remote:     Resolve the following violations before pushing again
remote:
remote:     - Push cannot contain secrets
remote:
remote:       â€”â€” Google Cloud Service Account Credentials â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
remote:        locations:
remote:          - commit: 5103ff8d86d1f0f829aa40ceec98cc0252333155
remote:            path: service_account_key.json:1
```

## Related Commits or Pull Requests
- ì»¤ë°‹ 5103ff8d86d1f0f829aa40ceec98cc0252333155ì—ì„œ ì„œë¹„ìŠ¤ ê³„ì • í‚¤ í¬í•¨
- .gitignore ì—…ë°ì´íŠ¸ë¡œ í–¥í›„ ë¯¼ê°í•œ íŒŒì¼ ì¶”ì  ë°©ì§€

## Reproduction Steps
1. ë¯¼ê°í•œ íŒŒì¼(API í‚¤, ì„œë¹„ìŠ¤ ê³„ì • í‚¤ ë“±)ì„ Git ì €ì¥ì†Œì— ì¶”ê°€
2. GitHubì— í‘¸ì‹œ ì‹œë„
3. Push Protectionì´ ìë™ìœ¼ë¡œ ë³´ì•ˆ ìœ„ë°˜ ê°ì§€
4. í‘¸ì‹œ ê±°ë¶€ ë° ë³´ì•ˆ ê²½ê³  í‘œì‹œ

## Prevention / Lessons Learned
- ë¯¼ê°í•œ íŒŒì¼ì€ í•­ìƒ .gitignoreì— ì¶”ê°€ í›„ ì»¤ë°‹
- ì„œë¹„ìŠ¤ ê³„ì • í‚¤ëŠ” í™˜ê²½ ë³€ìˆ˜ë‚˜ Azure Key Vault ì‚¬ìš© ê¶Œì¥
- GitHubì˜ Push Protection ê¸°ëŠ¥ í™œìš©ìœ¼ë¡œ ë³´ì•ˆ ê°•í™”
- ì»¤ë°‹ ì „ì— ë¯¼ê°í•œ ì •ë³´ í¬í•¨ ì—¬ë¶€ í™•ì¸ í•„ìš”
- ì •ê¸°ì ì¸ ë³´ì•ˆ ìŠ¤ìº”ìœ¼ë¡œ ì €ì¥ì†Œ ë³´ì•ˆ ìƒíƒœ ì ê²€

## Related Links
- GitHub Push Protection ë¬¸ì„œ
- Google Cloud ì„œë¹„ìŠ¤ ê³„ì • ë³´ì•ˆ ê°€ì´ë“œ
- Azure Key Vault ì„œë¹„ìŠ¤ ê³„ì • í‚¤ ê´€ë¦¬ 

---

## Metadata
- Timestamp: 2025-07-12 16:42:00 KST
- Severity: Medium
- Impacted Systems: storeToCosmos Azure Function, Azure SQL Database
- Tags: ODBC, SQL Server, ë¡œì»¬ ê°œë°œ, ë“œë¼ì´ë²„, í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ

## Problem Summary
Azure Functions ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œ CosmosDB ëŒ€ì‹  Azure SQL Databaseë¡œ ë³€ê²½í•œ í›„, ë¡œì»¬ì—ì„œ `func start` ì‹¤í–‰ ì‹œ ODBC ë“œë¼ì´ë²„ ê´€ë ¨ ì˜¤ë¥˜ì™€ í…Œì´ë¸” ì—†ìŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

## Root Cause
- ë¡œì»¬ ì»´í“¨í„°ì— ODBC Driverê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŒ
- ì½”ë“œì—ì„œ ì§€ì •í•œ ODBC Driver ë²„ì „(17)ê³¼ ì„¤ì¹˜ëœ ë²„ì „(18) ë¶ˆì¼ì¹˜
- Azure SQL Databaseì— í•„ìš”í•œ í…Œì´ë¸”ê³¼ ìŠ¤í‚¤ë§ˆê°€ ìƒì„±ë˜ì–´ ìˆì§€ ì•ŠìŒ

## Resolution Steps
1. **ODBC Driver ì„¤ì¹˜**: Microsoftì—ì„œ ì œê³µí•˜ëŠ” ODBC Driver 18 for SQL Server ì„¤ì¹˜
2. **ë“œë¼ì´ë²„ ë²„ì „ ìˆ˜ì •**: clients.py íŒŒì¼ì—ì„œ ì—°ê²° ë¬¸ìì—´ì˜ ë“œë¼ì´ë²„ ë²„ì „ì„ 17ì—ì„œ 18ë¡œ ë³€ê²½
3. **SQL ìŠ¤í‚¤ë§ˆ ìƒì„±**: Azure Portalì˜ ì¿¼ë¦¬ í¸ì§‘ê¸°ì—ì„œ ga_data ìŠ¤í‚¤ë§ˆ ìƒì„±
4. **SQL í…Œì´ë¸” ìƒì„±**: í•„ìš”í•œ 7ê°œ í…Œì´ë¸”(Sessions, Totals, Traffic, DeviceGeo, CustomDimensions, Hits, HitsProduct) ìƒì„±

## Error Message / Logs
**ODBC ë“œë¼ì´ë²„ ì˜¤ë¥˜:**
```
InterfaceError: ('IM002', '[IM002] [Microsoft][ODBC ë“œë¼ì´ë²„ ê´€ë¦¬ì] ë°ì´í„° ì›ë³¸ ì´ë¦„ì´ ì—†ê³  ê¸°ë³¸ ë“œë¼ì´ë²„ë¥¼ ì§€ì •í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (0) (SQLDriverConnect)')
```

**í…Œì´ë¸” ì—†ìŒ ì˜¤ë¥˜:**
```
('42S02', "[42S02] [Microsoft][ODBC Driver 18 for SQL Server][SQL Server]Invalid object name 'ga_data.Sessions'. (208) (SQLExecDirectW); [42S02] [Microsoft][ODBC Driver 18 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)")
```

## Related Commits or Pull Requests
- clients.py íŒŒì¼ ìˆ˜ì •: ODBC Driver ë²„ì „ 17ì—ì„œ 18ë¡œ ë³€ê²½
- create_tables.sql ìŠ¤í¬ë¦½íŠ¸ ìƒì„±: í•„ìš”í•œ í…Œì´ë¸”ê³¼ ìŠ¤í‚¤ë§ˆ ìƒì„±

## Reproduction Steps
1. Azure Functions ë¡œì»¬ ê°œë°œ í™˜ê²½ ì„¤ì •
2. Azure SQL Database ì—°ê²° ì •ë³´ êµ¬ì„±
3. ë¡œì»¬ì—ì„œ `func start` ì‹¤í–‰
4. ODBC ë“œë¼ì´ë²„ ì˜¤ë¥˜ ë°œìƒ í™•ì¸
5. ë“œë¼ì´ë²„ ì„¤ì¹˜ í›„ ë‹¤ì‹œ ì‹¤í–‰í•˜ì—¬ í…Œì´ë¸” ì—†ìŒ ì˜¤ë¥˜ í™•ì¸

## Prevention / Lessons Learned
- í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤(Azure SQL Database)ë¥¼ ì‚¬ìš©í•˜ë”ë¼ë„ ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ëŠ” í•„ìš”í•œ ë“œë¼ì´ë²„ ì„¤ì¹˜ í•„ìš”
- ì—°ê²° ë¬¸ìì—´ì— ì§€ì •ëœ ë“œë¼ì´ë²„ ë²„ì „ê³¼ ì‹¤ì œ ì„¤ì¹˜ëœ ë²„ì „ ì¼ì¹˜ í•„ìš”
- ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆì™€ í…Œì´ë¸”ì€ ì½”ë“œ ë°°í¬ ì „ì— ë¯¸ë¦¬ ìƒì„± í•„ìš”
- ë¡œì»¬ ê°œë°œê³¼ í´ë¼ìš°ë“œ í™˜ê²½ì˜ ì°¨ì´ì  ì´í•´ í•„ìš”

## Related Links
- Microsoft ODBC Driver for SQL Server ë‹¤ìš´ë¡œë“œ: https://learn.microsoft.com/ko-kr/sql/connect/odbc/download-odbc-driver-for-sql-server
- Azure SQL Database ì—°ê²° ë¬¸ìì—´ í˜•ì‹: https://learn.microsoft.com/ko-kr/azure/azure-sql/database/connect-query-content-reference-guide 

---

## Metadata
- Timestamp: 2023-07-13 14:25:00 KST
- Severity: Low
- Impacted Systems: storeToSQL Azure Function
- Tags: ë°ì´í„° ì²˜ë¦¬, ì¡°ê±´ë¶€ í•„í„°ë§, SQL

## Problem Summary
ë°ì´í„° ì²˜ë¦¬ ê²°ê³¼ì—ì„œ ì¼ë¶€ í…Œì´ë¸”(custom, products)ì˜ ë°ì´í„° ê°œìˆ˜ê°€ ë‹¤ë¥¸ í…Œì´ë¸”(sessions, totals, traffic, devicegeo, hits)ê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì„¸ì…˜ ë°ì´í„°ëŠ” ëª¨ë‘ 1000ê°œì”© ì²˜ë¦¬ë˜ì—ˆìœ¼ë‚˜, customì€ 838ê°œ, productsëŠ” 911ê°œë§Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.

## Root Cause
- `data_processors.py` íŒŒì¼ì˜ `_process_custom_data` í•¨ìˆ˜ì—ì„œ customDimensions_indexê°€ Noneì¸ ê²½ìš° ë°ì´í„° ì²˜ë¦¬ë¥¼ ê±´ë„ˆë›°ë„ë¡ ì„¤ì •ë¨
- `_process_products_data` í•¨ìˆ˜ì—ì„œ hits_product_v2ProductNameì´ Noneì¸ ê²½ìš° ë°ì´í„° ì²˜ë¦¬ë¥¼ ê±´ë„ˆë›°ë„ë¡ ì„¤ì •ë¨
- ì´ë¡œ ì¸í•´ í•´ë‹¹ í•„ë“œê°€ ì—†ëŠ” ë°ì´í„°ëŠ” ì²˜ë¦¬ë˜ì§€ ì•Šì•„ í…Œì´ë¸”ë³„ ë°ì´í„° ìˆ˜ì˜ ë¶ˆì¼ì¹˜ ë°œìƒ

## Resolution Steps
1. `data_processors.py` íŒŒì¼ì˜ `_process_custom_data` í•¨ìˆ˜ì—ì„œ ì¡°ê±´ë¶€ í•„í„°ë§ ì œê±°
   ```python
   # ìˆ˜ì • ì „
   if getattr(row, 'customDimensions_index', None) is None:
       return
   ```
   
2. `_process_products_data` í•¨ìˆ˜ì—ì„œ ì¡°ê±´ë¶€ í•„í„°ë§ ì œê±°
   ```python
   # ìˆ˜ì • ì „
   if getattr(row, 'hits_product_v2ProductName', None) is None:
       return
   ```

3. ë‘ í•¨ìˆ˜ ëª¨ë‘ì—ì„œ ì¡°ê±´ ê²€ì‚¬ë¥¼ ì œê±°í•˜ì—¬ ëª¨ë“  ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ë„ë¡ ìˆ˜ì •

## Error Message / Logs
```
âœ… ì €ì¥ ì™„ë£Œ:
ğŸ“Š ì´ ì²˜ë¦¬ëœ ë°ì´í„°: 6749ê°œ
  â€¢ sessions: 1000ê°œ
  â€¢ totals: 1000ê°œ
  â€¢ traffic: 1000ê°œ
  â€¢ devicegeo: 1000ê°œ
  â€¢ custom: 838ê°œ
  â€¢ hits: 1000ê°œ
  â€¢ products: 911ê°œ
```

## Related Commits or Pull Requests
- data_processors.py íŒŒì¼ ìˆ˜ì •: customDimensions_index ë° hits_product_v2ProductName ê´€ë ¨ ì¡°ê±´ë¶€ í•„í„°ë§ ì œê±°

## Reproduction Steps
1. ê¸°ì¡´ ì½”ë“œë¡œ ë°ì´í„° ì²˜ë¦¬ ì‹¤í–‰
2. ì²˜ë¦¬ ê²°ê³¼ í™•ì¸í•˜ì—¬ í…Œì´ë¸”ë³„ ë°ì´í„° ìˆ˜ ë¶ˆì¼ì¹˜ í™•ì¸
3. data_processors.py íŒŒì¼ì˜ ì¡°ê±´ë¶€ í•„í„°ë§ ì½”ë“œ í™•ì¸
4. ì¡°ê±´ë¶€ í•„í„°ë§ ì œê±° í›„ ë°ì´í„° ì²˜ë¦¬ ì¬ì‹¤í–‰

## Prevention / Lessons Learned
- ë°ì´í„° ì²˜ë¦¬ ì‹œ í•„ë“œ ì¡´ì¬ ì—¬ë¶€ì— ë”°ë¥¸ í•„í„°ë§ì´ í•„ìš”í•œì§€ ëª…í™•íˆ íŒë‹¨ í•„ìš”
- ë°ì´í„° ì¼ê´€ì„±ì´ ì¤‘ìš”í•œ ê²½ìš°, ì¡°ê±´ë¶€ í•„í„°ë§ë³´ë‹¤ ëª¨ë“  ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ê³  NULL ê°’ í—ˆìš©í•˜ëŠ” ë°©ì‹ ê³ ë ¤
- ë°ì´í„° ì²˜ë¦¬ ê²°ê³¼ë¥¼ ì •ê¸°ì ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•˜ì—¬ ì˜ˆìƒê³¼ ë‹¤ë¥¸ ê²°ê³¼ ë°œìƒ ì‹œ ì›ì¸ íŒŒì•… í•„ìš”
- ë°ì´í„° ì²˜ë¦¬ ë¡œì§ ë³€ê²½ ì‹œ ê²°ê³¼ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ ì‚¬ì „ ê²€í†  í•„ìš”

## Related Links
- Azure SQL Database NULL ê°’ ì²˜ë¦¬ ê°€ì´ë“œ
- Google Analytics ë°ì´í„° êµ¬ì¡° ë¬¸ì„œ 

---

## Metadata
- Timestamp: 2023-07-14 10:35:00 KST
- Severity: Medium
- Impacted Systems: storeToSQL Azure Function
- Tags: ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ, NULL ê°’ ì œì•½ì¡°ê±´, í…Œì´ë¸” ì‚­ì œ

## Problem Summary
CustomDimensions í…Œì´ë¸”ì— NULL ê°’ì„ ì‚½ì…í•˜ë ¤ê³  í•  ë•Œ SQL ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. dimensionIndex ì—´ì´ NOT NULL ì œì•½ì¡°ê±´ì„ ê°€ì§€ê³  ìˆì–´ NULL ê°’ì„ í—ˆìš©í•˜ì§€ ì•ŠëŠ” ë¬¸ì œê°€ ìˆì—ˆìŠµë‹ˆë‹¤.

## Root Cause
- CustomDimensions í…Œì´ë¸”ì˜ dimensionIndex ì—´ì´ NOT NULL ì œì•½ì¡°ê±´ìœ¼ë¡œ ì„¤ì •ë¨
- ìµœê·¼ ì½”ë“œ ìˆ˜ì •ìœ¼ë¡œ customDimensions_indexê°€ NULLì¸ ë°ì´í„°ë„ ì²˜ë¦¬í•˜ë„ë¡ ë³€ê²½í–ˆìœ¼ë‚˜ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆì™€ ì¶©ëŒ
- ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆì™€ ì½”ë“œ ë¡œì§ ê°„ì˜ ë¶ˆì¼ì¹˜ë¡œ ì¸í•œ ì˜¤ë¥˜ ë°œìƒ

## Resolution Steps
1. CustomDimensions í…Œì´ë¸”ì„ ì™„ì „íˆ ì œê±°í•˜ê¸°ë¡œ ê²°ì •
2. schema.sql íŒŒì¼ì—ì„œ CustomDimensions í…Œì´ë¸” ìƒì„± ì½”ë“œ ì‚­ì œ
   ```sql
   -- ì‚­ì œëœ ì½”ë“œ
   CREATE TABLE ga_data.CustomDimensions (
       cdId VARCHAR(255) PRIMARY KEY,
       hitId VARCHAR(255),
       visitorId VARCHAR(255),
       dimensionIndex INT NOT NULL,
       dimensionValue NVARCHAR(MAX)
   );
   ```

3. data_processors.py íŒŒì¼ì—ì„œ CustomDimensions ê´€ë ¨ ì²˜ë¦¬ ë¡œì§ ì œê±°
   - tables ë”•ì…”ë„ˆë¦¬ì—ì„œ "custom" í•­ëª© ì œê±°
   - _process_custom_data í•¨ìˆ˜ë¥¼ ë¹ˆ í•¨ìˆ˜ë¡œ ë³€ê²½
   - process_row ë©”ì†Œë“œì—ì„œ _process_custom_data í•¨ìˆ˜ í˜¸ì¶œ ì œê±°

4. ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ í…Œì´ë¸” ì‚­ì œ (Azure Portal ì¿¼ë¦¬ í¸ì§‘ê¸° ì‚¬ìš©)
   ```sql
   DROP TABLE IF EXISTS ga_data.CustomDimensions;
   ```

## Error Message / Logs
```
[2025-07-14T02:30:31.830Z] ë°°ì¹˜ ì‚½ì… ì‹¤íŒ¨ (ga_data.CustomDimensions): ('23000', "[23000] [Microsoft][ODBC Driver 18 for SQL Server][SQL Server]Cannot insert the value NULL into column 'dimensionIndex', table 'dt016-test-sqldb.ga_data.CustomDimensions'; column does not allow nulls. INSERT fails. (515) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 18 for SQL Server][SQL Server]The statement has been terminated. (3621)")
[2025-07-14T02:30:31.866Z] í–‰ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ (fullVisitorId: 5012431536154633744, primary_key: 20170801-0000453): ('23000', "[23000] [Microsoft][ODBC Driver 18 for SQL Server][SQL Server]Cannot insert the value NULL into column 'dimensionIndex', table 'dt016-test-sqldb.ga_data.CustomDimensions'; column does not allow nulls. INSERT fails. (515) (SQLExecDirectW); [23000] [Microsoft][ODBC Driver 18 for SQL Server][SQL Server]The statement has been terminated. (3621)")
```

## Related Commits or Pull Requests
- schema.sql íŒŒì¼ ìˆ˜ì •: CustomDimensions í…Œì´ë¸” ìƒì„± ì½”ë“œ ì œê±°
- data_processors.py íŒŒì¼ ìˆ˜ì •: CustomDimensions ê´€ë ¨ ì²˜ë¦¬ ë¡œì§ ì œê±°

## Reproduction Steps
1. ì½”ë“œì—ì„œ NULL ê°’ì„ í—ˆìš©í•˜ë„ë¡ ìˆ˜ì •
2. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆì—ì„œëŠ” NOT NULL ì œì•½ì¡°ê±´ì´ ìˆëŠ” ìƒíƒœ
3. í•¨ìˆ˜ ì‹¤í–‰ ì‹œ NULL ê°’ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì‚½ì…í•˜ë ¤ê³  ì‹œë„
4. SQL ì˜¤ë¥˜ ë°œìƒ í™•ì¸

## Prevention / Lessons Learned
- ì½”ë“œ ë¡œì§ê³¼ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ê°„ì˜ ì¼ê´€ì„± ìœ ì§€ í•„ìš”
- ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì‹œ ê´€ë ¨ ì½”ë“œë„ í•¨ê»˜ ê²€í†  í•„ìš”
- NULL ê°’ ì²˜ë¦¬ ì •ì±…ì„ ëª…í™•íˆ ìˆ˜ë¦½í•˜ê³  ì½”ë“œì™€ ìŠ¤í‚¤ë§ˆì— ì¼ê´€ë˜ê²Œ ì ìš©
- í…Œì´ë¸”ì´ í•„ìš”í•˜ì§€ ì•Šì€ ê²½ìš° ì™„ì „íˆ ì œê±°í•˜ì—¬ ë¶ˆí•„ìš”í•œ ì˜¤ë¥˜ ë°©ì§€
- ë°ì´í„°ë² ì´ìŠ¤ ì œì•½ì¡°ê±´ê³¼ ì½”ë“œ ë¡œì§ì´ ì¶©ëŒí•  ë•ŒëŠ” ë‘˜ ì¤‘ í•˜ë‚˜ë¥¼ ì¡°ì •í•˜ê±°ë‚˜ ë¶ˆí•„ìš”í•œ ê¸°ëŠ¥ ì œê±° ê³ ë ¤

## Related Links
- SQL Server NOT NULL ì œì•½ì¡°ê±´ ë¬¸ì„œ
- Azure SQL Database ìŠ¤í‚¤ë§ˆ ê´€ë¦¬ ê°€ì´ë“œ 

---

## Metadata
- Timestamp: 2023-07-14 14:20:00 KST
- Severity: Low
- Impacted Systems: storeToSQL Azure Function
- Tags: ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ, í•„ë“œ ì¶”ê°€, ë°ì´í„° í™•ì¥

## Problem Summary
íŒ€ì¥ì˜ ìš”ì²­ìœ¼ë¡œ Hits í…Œì´ë¸”ì— product_productQuantity í•„ë“œë¥¼ ì¶”ê°€í•´ì•¼ í–ˆìŠµë‹ˆë‹¤. ì´ í•„ë“œëŠ” Google Analytics ë°ì´í„°ì—ì„œ ì œí’ˆ ìˆ˜ëŸ‰ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ìš©ë„ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.

## Root Cause
- ê¸°ì¡´ ìŠ¤í‚¤ë§ˆì—ëŠ” product_productQuantity í•„ë“œê°€ ì •ì˜ë˜ì–´ ìˆì§€ ì•Šì•˜ìŒ
- BigQueryì—ì„œëŠ” p.productQuantityë¡œ ë°ì´í„°ê°€ ì œê³µë˜ì§€ë§Œ ì´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¿¼ë¦¬ì— í¬í•¨ë˜ì–´ ìˆì§€ ì•Šì•˜ìŒ
- ë°ì´í„° ì²˜ë¦¬ ë¡œì§ì—ì„œë„ í•´ë‹¹ í•„ë“œë¥¼ ì²˜ë¦¬í•˜ëŠ” ì½”ë“œê°€ ì—†ì—ˆìŒ

## Resolution Steps
1. schema.sql íŒŒì¼ì˜ Hits í…Œì´ë¸” ì •ì˜ì— product_productQuantity í•„ë“œ ì¶”ê°€
   ```sql
   CREATE TABLE ga_data.Hits (
       -- ê¸°ì¡´ í•„ë“œë“¤...
       contentGroupUniqueViews2 INT,
       contentGroupUniqueViews3 INT,
       product_productQuantity INT,  -- ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œ
       dataSource VARCHAR(255)
   );
   ```

2. data_processors.py íŒŒì¼ì˜ _process_hits_data í•¨ìˆ˜ ìˆ˜ì •
   - hits_data ë°°ì—´ì— getattr(row, 'hits_product_productQuantity', None) ì¶”ê°€
   - columns ë°°ì—´ì— "product_productQuantity" ì¶”ê°€

3. queries.py íŒŒì¼ì˜ BigQuery ì¿¼ë¦¬ ìˆ˜ì •
   - SELECT ì ˆì— p.productQuantity AS hits_product_productQuantity ì¶”ê°€

4. ë°ì´í„°ë² ì´ìŠ¤ì— ë³€ê²½ì‚¬í•­ ì ìš© (Azure Portal ì¿¼ë¦¬ í¸ì§‘ê¸° ì‚¬ìš©)
   ```sql
   ALTER TABLE ga_data.Hits
   ADD product_productQuantity INT;
   ```

## Error Message / Logs
ë³€ê²½ ì „ì—ëŠ” í•´ë‹¹ í•„ë“œê°€ ì—†ì–´ ë°ì´í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.

## Related Commits or Pull Requests
- schema.sql íŒŒì¼ ìˆ˜ì •: Hits í…Œì´ë¸”ì— product_productQuantity INT í•„ë“œ ì¶”ê°€
- data_processors.py íŒŒì¼ ìˆ˜ì •: _process_hits_data í•¨ìˆ˜ì— product_productQuantity ì²˜ë¦¬ ì¶”ê°€
- queries.py íŒŒì¼ ìˆ˜ì •: BigQuery ì¿¼ë¦¬ì— p.productQuantity AS hits_product_productQuantity ì¶”ê°€

## Reproduction Steps
1. íŒ€ì¥ì˜ ìš”ì²­ì— ë”°ë¼ ì œí’ˆ ìˆ˜ëŸ‰ ì •ë³´ë¥¼ ì €ì¥í•  í•„ë“œ ì¶”ê°€ í•„ìš” í™•ì¸
2. schema.sql, data_processors.py, queries.py íŒŒì¼ì—ì„œ ê´€ë ¨ ì½”ë“œ ìˆ˜ì •
3. ë°ì´í„°ë² ì´ìŠ¤ì— ë³€ê²½ì‚¬í•­ ì ìš©
4. ë³€ê²½ëœ ì½”ë“œë¡œ í•¨ìˆ˜ ì‹¤í–‰í•˜ì—¬ ì œí’ˆ ìˆ˜ëŸ‰ ì •ë³´ê°€ ì •ìƒì ìœ¼ë¡œ ì €ì¥ë˜ëŠ”ì§€ í™•ì¸

## Prevention / Lessons Learned
- ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì‹œ ê´€ë ¨ëœ ëª¨ë“  ì½”ë“œ íŒŒì¼ì„ í•¨ê»˜ ìˆ˜ì •í•´ì•¼ í•¨
- ë°ì´í„° ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ì—ì„œ í•„ë“œ ì¶”ê°€ ì‹œ ì†ŒìŠ¤(BigQuery), ì²˜ë¦¬ ë¡œì§, ì €ì¥ì†Œ(SQL DB) ëª¨ë‘ ì¼ê´€ë˜ê²Œ ë³€ê²½ í•„ìš”
- í•„ë“œ ì¶”ê°€ ì‹œ NULL í—ˆìš© ì—¬ë¶€ë¥¼ ëª…í™•íˆ ê²°ì •í•˜ê³  ìŠ¤í‚¤ë§ˆì— ë°˜ì˜
- ìŠ¤í‚¤ë§ˆ ë³€ê²½ í›„ ê¸°ì¡´ ë°ì´í„°ë² ì´ìŠ¤ì— ë³€ê²½ì‚¬í•­ ì ìš© í•„ìš”
- ë°ì´í„° íŒŒì´í”„ë¼ì¸ ìˆ˜ì • ì‹œ ì „ì²´ íë¦„ì„ ê³ ë ¤í•˜ì—¬ ëˆ„ë½ëœ ë¶€ë¶„ì´ ì—†ëŠ”ì§€ í™•ì¸ í•„ìš”

## Related Links
- Google Analytics ë°ì´í„° ìŠ¤í‚¤ë§ˆ ë¬¸ì„œ
- BigQuery ì¿¼ë¦¬ ìµœì í™” ê°€ì´ë“œ
- Azure SQL Database ìŠ¤í‚¤ë§ˆ ë³€ê²½ ê°€ì´ë“œ 

---

## Metadata
- Timestamp: 2024-11-06 14:30:00 KST
- Severity: Medium
- Impacted Systems: Azure SQL Database, BigQuery Export
- Tags: Data Type, Schema, BigQuery

## Problem Summary
Google Analytics ë°ì´í„° ìŠ¤í‚¤ë§ˆì™€ Azure SQL ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ê°„ì˜ ë°ì´í„° íƒ€ì… ë¶ˆì¼ì¹˜ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

## Root Cause
Google Analytics ê³µì‹ ë¬¸ì„œì— ë”°ë¥´ë©´ BigQuery Export ìŠ¤í‚¤ë§ˆì—ì„œëŠ” BIGINT íƒ€ì…ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  INTEGER íƒ€ì…ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ìš°ë¦¬ í”„ë¡œì íŠ¸ì˜ schema.sql íŒŒì¼ì—ì„œëŠ” transactionRevenue, totalTransactionRevenue, productPrice, localProductPrice í•„ë“œì— BIGINT íƒ€ì…ì„ ì‚¬ìš©í•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤.

## Resolution Steps
1. Google Analytics ê³µì‹ ë¬¸ì„œë¥¼ í™•ì¸í•˜ì—¬ ì˜¬ë°”ë¥¸ ë°ì´í„° íƒ€ì…ì„ íŒŒì•…í–ˆìŠµë‹ˆë‹¤.
2. schema.sql íŒŒì¼ì—ì„œ BIGINT íƒ€ì…ì„ ì‚¬ìš©í•˜ëŠ” ëª¨ë“  í•„ë“œë¥¼ INTEGER íƒ€ì…ìœ¼ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.
3. ë³€ê²½ëœ í•„ë“œ:
   - ga_data.Totals í…Œì´ë¸”ì˜ transactionRevenue
   - ga_data.Totals í…Œì´ë¸”ì˜ totalTransactionRevenue
   - ga_data.HitsProduct í…Œì´ë¸”ì˜ productPrice
   - ga_data.HitsProduct í…Œì´ë¸”ì˜ localProductPrice

## Error Message / Logs
ë°ì´í„° íƒ€ì… ë¶ˆì¼ì¹˜ë¡œ ì¸í•œ ëª…ì‹œì ì¸ ì˜¤ë¥˜ëŠ” ë°œìƒí•˜ì§€ ì•Šì•˜ìœ¼ë‚˜, Google Analytics ê³µì‹ ë¬¸ì„œì™€ì˜ ì¼ê´€ì„±ì„ ìœ„í•´ ìˆ˜ì •ì´ í•„ìš”í–ˆìŠµë‹ˆë‹¤.

## Related Commits or Pull Requests
N/A

## Reproduction Steps
1. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ ì„¤ê³„í•  ë•ŒëŠ” í•­ìƒ ë°ì´í„° ì†ŒìŠ¤ì˜ ê³µì‹ ë¬¸ì„œë¥¼ ì°¸ì¡°í•˜ì—¬ ë°ì´í„° íƒ€ì…ì„ ì •í™•í•˜ê²Œ ë§ì¶”ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. íŠ¹íˆ ì™¸ë¶€ ì‹œìŠ¤í…œê³¼ ì—°ë™í•  ë•ŒëŠ” ë°ì´í„° íƒ€ì… ë¶ˆì¼ì¹˜ë¡œ ì¸í•œ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì£¼ì˜í•´ì•¼ í•©ë‹ˆë‹¤.

## Prevention / Lessons Learned
ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ ì„¤ê³„í•  ë•ŒëŠ” í•­ìƒ ë°ì´í„° ì†ŒìŠ¤ì˜ ê³µì‹ ë¬¸ì„œë¥¼ ì°¸ì¡°í•˜ì—¬ ë°ì´í„° íƒ€ì…ì„ ì •í™•í•˜ê²Œ ë§ì¶”ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. íŠ¹íˆ ì™¸ë¶€ ì‹œìŠ¤í…œê³¼ ì—°ë™í•  ë•ŒëŠ” ë°ì´í„° íƒ€ì… ë¶ˆì¼ì¹˜ë¡œ ì¸í•œ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì£¼ì˜í•´ì•¼ í•©ë‹ˆë‹¤.

## Related Links
- https://support.google.com/analytics/answer/3437719?hl=en
- https://support.google.com/analytics/answer/7029846?hl=en 

---

## Metadata
- Timestamp: 2024-11-06 17:45:00 KST
- Severity: Medium
- Impacted Systems: storeToSQL Azure Function, BigQuery ì¿¼ë¦¬
- Tags: ì¿¼ë¦¬ ì—…ë°ì´íŠ¸, BigQuery, ë°ì´í„° ì²˜ë¦¬

## Problem Summary
íŒ€ì¥ì˜ ìš”ì²­ì— ë”°ë¼ BigQuery ì¿¼ë¦¬ë¥¼ ì—…ë°ì´íŠ¸í•´ì•¼ í–ˆìŠµë‹ˆë‹¤. ê¸°ì¡´ ì¿¼ë¦¬ì—ì„œ ì¼ë¶€ í•„ë“œì˜ ì²˜ë¦¬ ë°©ì‹ê³¼ ë°ì´í„° í˜•ì‹ì´ ë³€ê²½ë˜ì–´ì•¼ í–ˆìŠµë‹ˆë‹¤.

## Root Cause
ê¸°ì¡´ ì¿¼ë¦¬ëŠ” ì¼ë¶€ í•„ë“œì— ëŒ€í•œ ì²˜ë¦¬ê°€ ìµœì‹  ìš”êµ¬ì‚¬í•­ê³¼ ì¼ì¹˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. íŠ¹íˆ ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œê°€ ìˆì—ˆìŠµë‹ˆë‹¤:
- Boolean í•„ë“œ(isInteraction, isEntrance, isExit, isImpression, isClick)ì— IFNULL ì²˜ë¦¬ê°€ ëˆ„ë½ë¨
- ìˆ«ì í•„ë“œ(totalTransactionRevenue, productPrice)ì— ROUND í•¨ìˆ˜ê°€ ì ìš©ë˜ì§€ ì•ŠìŒ
- eCommerceAction.action_typeì˜ CASE ë¬¸ì— 'Checkout options' ì˜µì…˜ì´ ëˆ„ë½ë¨
- productRevenue í•„ë“œê°€ ì¿¼ë¦¬ì— í¬í•¨ë˜ì§€ ì•ŠìŒ

## Resolution Steps
1. queries.py íŒŒì¼ì˜ get_analytics_data_query í•¨ìˆ˜ë¥¼ ìˆ˜ì •í•˜ì—¬ íŒ€ì¥ì´ ì œê³µí•œ ì¿¼ë¦¬ë¡œ ì—…ë°ì´íŠ¸í–ˆìŠµë‹ˆë‹¤.
2. ì£¼ìš” ë³€ê²½ ì‚¬í•­:
   - Boolean í•„ë“œì— IFNULL í•¨ìˆ˜ ì ìš©: `IFNULL(h.isInteraction, FALSE)`, `IFNULL(h.isEntrance, FALSE)`, `IFNULL(h.isExit, FALSE)`, `IFNULL(p.isImpression, FALSE)`, `IFNULL(p.isClick, FALSE)`
   - ìˆ«ì í•„ë“œì— ROUND í•¨ìˆ˜ ì ìš©: `ROUND(t.totals.totalTransactionRevenue / 1000000, 2)`, `ROUND(p.productPrice / 1000000, 2)`
   - eCommerceAction.action_type CASE ë¬¸ì— 'Checkout options' ì˜µì…˜ ì¶”ê°€
   - productRevenue í•„ë“œ ì¶”ê°€: `ROUND(p.productRevenue / 1000000, 2) AS hits_product_productRevenue`
3. data_processors.py íŒŒì¼ë„ ìˆ˜ì •í•˜ì—¬ ìƒˆë¡œìš´ í•„ë“œ(productRevenue)ë¥¼ ì²˜ë¦¬í•˜ë„ë¡ í–ˆìŠµë‹ˆë‹¤.
4. schema.sql íŒŒì¼ì— HitsProduct í…Œì´ë¸”ì— productRevenue í•„ë“œë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.

## Error Message / Logs
í•´ë‹¹ ì—†ìŒ

## Related Commits or Pull Requests
- queries.py íŒŒì¼ ìˆ˜ì •: BigQuery ì¿¼ë¦¬ ì—…ë°ì´íŠ¸
- data_processors.py íŒŒì¼ ìˆ˜ì •: productRevenue í•„ë“œ ì²˜ë¦¬ ì¶”ê°€ ë° action_type_mapì— 'Checkout options' ì¶”ê°€
- schema.sql íŒŒì¼ ìˆ˜ì •: HitsProduct í…Œì´ë¸”ì— productRevenue INTEGER í•„ë“œ ì¶”ê°€

## Reproduction Steps
1. íŒ€ì¥ì´ ì œê³µí•œ ì¿¼ë¦¬ë¥¼ ê²€í† 
2. ê¸°ì¡´ ì¿¼ë¦¬ì™€ ë¹„êµí•˜ì—¬ ë³€ê²½ ì‚¬í•­ íŒŒì•…
3. queries.py, data_processors.py, schema.sql íŒŒì¼ ìˆ˜ì •
4. ë³€ê²½ëœ ì½”ë“œë¡œ í•¨ìˆ˜ ì‹¤í–‰í•˜ì—¬ ì •ìƒ ì‘ë™ í™•ì¸

## Prevention / Lessons Learned
- ì¿¼ë¦¬ ë³€ê²½ ì‹œ ê´€ë ¨ëœ ëª¨ë“  ì½”ë“œ íŒŒì¼(ë°ì´í„° ì²˜ë¦¬ ë¡œì§, ìŠ¤í‚¤ë§ˆ ì •ì˜)ì„ í•¨ê»˜ ê²€í† í•˜ê³  ìˆ˜ì •í•´ì•¼ í•¨
- ìƒˆë¡œìš´ í•„ë“œ ì¶”ê°€ ì‹œ ë°ì´í„° íŒŒì´í”„ë¼ì¸ì˜ ëª¨ë“  ë‹¨ê³„(ì¿¼ë¦¬, ì²˜ë¦¬, ì €ì¥)ì—ì„œ ì¼ê´€ë˜ê²Œ ì²˜ë¦¬ë˜ì–´ì•¼ í•¨
- NULL ê°’ ì²˜ë¦¬ì™€ ë°ì´í„° í˜•ì‹ ë³€í™˜(ROUND ë“±)ì€ ë°ì´í„° í’ˆì§ˆì— ì¤‘ìš”í•œ ì˜í–¥ì„ ë¯¸ì¹˜ë¯€ë¡œ ì‹ ì¤‘í•˜ê²Œ ì²˜ë¦¬í•´ì•¼ í•¨
- ì¿¼ë¦¬ ë³€ê²½ í›„ì—ëŠ” ì‹¤ì œ ë°ì´í„°ë¡œ í…ŒìŠ¤íŠ¸í•˜ì—¬ ì˜ˆìƒëŒ€ë¡œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸ í•„ìš”

## Related Links
- Google Analytics BigQuery Export ìŠ¤í‚¤ë§ˆ ë¬¸ì„œ
- Azure SQL Database ë°ì´í„° íƒ€ì… ê°€ì´ë“œ 

---

## Metadata
- Timestamp: 2024-11-06 18:30:00 KST
- Severity: High
- Impacted Systems: storeToSQL Azure Function, Azure SQL Database, Power BI ì—°ë™
- Tags: ë°ì´í„° ëª¨ë¸ë§, í‚¤ ê´€ê³„, ìŠ¤í‚¤ë§ˆ ë³€ê²½, Power BI

## Problem Summary
íŒ€ì¥ì˜ ìš”ì²­ì— ë”°ë¼ Power BIì—ì„œ í…Œì´ë¸” ê°„ ê´€ê³„ë¥¼ ëª…í™•í•˜ê²Œ ì„¤ì •í•  ìˆ˜ ìˆë„ë¡ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆì™€ ì½”ë“œë¥¼ ìˆ˜ì •í•´ì•¼ í–ˆìŠµë‹ˆë‹¤. ê¸°ì¡´ ì‹œìŠ¤í…œì—ì„œëŠ” í…Œì´ë¸” ê°„ ê´€ê³„ê°€ ëª…í™•í•˜ê²Œ ì •ì˜ë˜ì–´ ìˆì§€ ì•Šì•„ Power BIì—ì„œ ë°ì´í„° ëª¨ë¸ë§ì´ ì–´ë ¤ì› ìŠµë‹ˆë‹¤.

## Root Cause
ê¸°ì¡´ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆì—ì„œëŠ” ê° í…Œì´ë¸”ì´ ì„œë¡œ ë‹¤ë¥¸ í˜•ì‹ì˜ í‚¤ë¥¼ ì‚¬ìš©í•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤:
- Sessions, Totals, Traffic, DeviceGeo í…Œì´ë¸”ì€ ë‚ ì§œ ê¸°ë°˜ì˜ primary_key ì‚¬ìš©
- Hits í…Œì´ë¸”ì€ UUID í˜•ì‹ì˜ hitId ì‚¬ìš©
- HitsProduct í…Œì´ë¸”ì€ UUID í˜•ì‹ì˜ productId ì‚¬ìš©

ì´ë¡œ ì¸í•´ Power BIì—ì„œ í…Œì´ë¸” ê°„ ê´€ê³„ë¥¼ ì„¤ì •í•˜ê¸° ì–´ë ¤ì› ê³ , ë°ì´í„° ë¶„ì„ì´ ì œí•œë˜ì—ˆìŠµë‹ˆë‹¤.

## Resolution Steps
1. **ìŠ¤í‚¤ë§ˆ ì¬ì„¤ê³„**: íŒ€ì¥ì˜ ì§€ì¹¨ì— ë”°ë¼ ì„¸ ê°€ì§€ ë ˆë²¨ì˜ í‚¤ ì²´ê³„ë¥¼ ì„¤ê³„í–ˆìŠµë‹ˆë‹¤.
   - ì„¸ì…˜ ë ˆë²¨: `session_key = CONCAT(fullVisitorId, '-', visitId)`
   - íˆíŠ¸ ë ˆë²¨: `hit_key = CONCAT(fullVisitorId, '-', visitId, '-', hitNumber)`
   - ìƒí’ˆ ë ˆë²¨: `product_hit_key = CONCAT(fullVisitorId, '-', visitId, '-', hitNumber, '-', productSKU)`

2. **schema.sql íŒŒì¼ ìˆ˜ì •**:
   - Sessions, Totals, Traffic, DeviceGeo í…Œì´ë¸”ì— session_key í•„ë“œ ì¶”ê°€ (PRIMARY KEYë¡œ ì„¤ì •)
   - Hits í…Œì´ë¸”ì— hit_key(PRIMARY KEY)ì™€ session_key í•„ë“œ ì¶”ê°€
   - HitsProduct í…Œì´ë¸”ì— product_hit_key(PRIMARY KEY)ì™€ hit_key í•„ë“œ ì¶”ê°€
   - ê¸°ì¡´ í‚¤ í•„ë“œëŠ” ì´ì „ ë²„ì „ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€
   - ìƒˆë¡œìš´ ì¸ë±ìŠ¤ ì¶”ê°€: IX_Sessions_SessionKey, IX_Hits_SessionKey, IX_Hits_HitKey, IX_HitsProduct_HitKey

3. **queries.py íŒŒì¼ ìˆ˜ì •**:
   - BigQuery ì¿¼ë¦¬ì— ì„¸ ê°€ì§€ ìƒˆë¡œìš´ í‚¤ í•„ë“œ ì¶”ê°€:
     - `CONCAT(fullVisitorId, '-', CAST(visitId AS STRING)) AS session_key`
     - `CONCAT(fullVisitorId, '-', CAST(visitId AS STRING), '-', CAST(h.hitNumber AS STRING)) AS hit_key`
     - `CONCAT(fullVisitorId, '-', CAST(visitId AS STRING), '-', CAST(h.hitNumber AS STRING), '-', IFNULL(p.productSKU, 'null')) AS product_hit_key`
   - productSKU í•„ë“œë„ ì¶”ê°€: `p.productSKU AS hits_product_productSKU`

4. **data_processors.py íŒŒì¼ ìˆ˜ì •**:
   - process_row ë©”ì„œë“œì—ì„œ ìƒˆë¡œìš´ í‚¤ í•„ë“œë¥¼ ê°€ì ¸ì˜¤ë„ë¡ ìˆ˜ì •
   - ì„¸ì…˜ ì²˜ë¦¬ ë¡œì§ì„ primary_key ëŒ€ì‹  session_key ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½
   - ëª¨ë“  ì²˜ë¦¬ ë©”ì„œë“œì˜ ë§¤ê°œë³€ìˆ˜ì™€ ë°ì´í„° ë°°ì—´, ì»¬ëŸ¼ ë¦¬ìŠ¤íŠ¸ ìˆ˜ì •
   - ì´ì „ ë²„ì „ í˜¸í™˜ì„±ì„ ìœ„í•´ UUID ìƒì„± ë¡œì§ ìœ ì§€

## Error Message / Logs
í•´ë‹¹ ì—†ìŒ

## Related Commits or Pull Requests
- schema.sql íŒŒì¼ ìˆ˜ì •: ìƒˆë¡œìš´ í‚¤ í•„ë“œ ì¶”ê°€ ë° PRIMARY KEY ë³€ê²½
- queries.py íŒŒì¼ ìˆ˜ì •: ìƒˆë¡œìš´ í‚¤ í•„ë“œ ìƒì„± ì¿¼ë¦¬ ì¶”ê°€
- data_processors.py íŒŒì¼ ìˆ˜ì •: ìƒˆë¡œìš´ í‚¤ í•„ë“œ ì²˜ë¦¬ ë¡œì§ ì¶”ê°€

## Reproduction Steps
1. íŒ€ì¥ì˜ ì§€ì¹¨ ê²€í† : ì„¸ì…˜, íˆíŠ¸, ìƒí’ˆ ë ˆë²¨ë³„ í‚¤ ì²´ê³„ ì„¤ê³„
2. schema.sql íŒŒì¼ì—ì„œ í…Œì´ë¸” êµ¬ì¡° ìˆ˜ì •
3. queries.py íŒŒì¼ì—ì„œ BigQuery ì¿¼ë¦¬ ìˆ˜ì •
4. data_processors.py íŒŒì¼ì—ì„œ ë°ì´í„° ì²˜ë¦¬ ë¡œì§ ìˆ˜ì •
5. ë³€ê²½ëœ ì½”ë“œë¡œ ë°ì´í„° ì²˜ë¦¬ í…ŒìŠ¤íŠ¸

## Prevention / Lessons Learned
- ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ ì‹œ ë°ì´í„° ëª¨ë¸ë§ê³¼ ë¶„ì„ ë„êµ¬(Power BI ë“±)ì˜ ìš”êµ¬ì‚¬í•­ì„ ì´ˆê¸°ë¶€í„° ê³ ë ¤í•´ì•¼ í•¨
- í…Œì´ë¸” ê°„ ê´€ê³„ë¥¼ ëª…í™•í•˜ê²Œ ì •ì˜í•˜ëŠ” ê²ƒì´ ë°ì´í„° ë¶„ì„ê³¼ ì‹œê°í™”ì— ì¤‘ìš”í•¨
- í‚¤ ì²´ê³„ë¥¼ ì„¤ê³„í•  ë•Œ ë°ì´í„°ì˜ ê³„ì¸µ êµ¬ì¡°(ì„¸ì…˜ > íˆíŠ¸ > ìƒí’ˆ)ë¥¼ ë°˜ì˜í•´ì•¼ í•¨
- ê¸°ì¡´ ì‹œìŠ¤í…œê³¼ì˜ í˜¸í™˜ì„±ì„ ìœ„í•´ ì´ì „ í‚¤ í•„ë“œë¥¼ ìœ ì§€í•˜ë©´ì„œ ìƒˆë¡œìš´ í‚¤ ì²´ê³„ë¥¼ ë„ì…í•˜ëŠ” ë°©ì‹ì´ íš¨ê³¼ì ì„
- ì¸ë±ìŠ¤ë¥¼ ì ì ˆíˆ ì„¤ì •í•˜ì—¬ ê´€ê³„ ê¸°ë°˜ ì¿¼ë¦¬ì˜ ì„±ëŠ¥ì„ ìµœì í™”í•´ì•¼ í•¨

## Related Links
- Power BI ë°ì´í„° ëª¨ë¸ë§ ê°€ì´ë“œ
- Azure SQL Database ê´€ê³„í˜• ë°ì´í„° ëª¨ë¸ ì„¤ê³„ ê°€ì´ë“œ 

---

## Metadata
- Timestamp: 2025-07-15 10:30:00 KST
- Severity: Low
- Impacted Systems: storeToSQL Azure Function, Azure SQL Database
- Tags: ë°ì´í„° íƒ€ì…, SQL, ìŠ¤í‚¤ë§ˆ, í˜¸í™˜ì„±

## Problem Summary
BigQueryì™€ Azure SQL Database ê°„ ë°ì´í„° íƒ€ì… ì°¨ì´ë¡œ ì¸í•´ ìŠ¤í‚¤ë§ˆ ì •ì˜ ì‹œ í˜¼ë€ì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤. BigQueryì—ì„œëŠ” ë¬¸ìì—´ ë°ì´í„° íƒ€ì…ìœ¼ë¡œ STRINGì„ ì‚¬ìš©í•˜ì§€ë§Œ, Azure SQL Databaseì—ì„œëŠ” VARCHAR/NVARCHARë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

## Root Cause
- BigQueryì™€ Azure SQL DatabaseëŠ” ì„œë¡œ ë‹¤ë¥¸ ë°ì´í„°ë² ì´ìŠ¤ ì‹œìŠ¤í…œìœ¼ë¡œ, ì§€ì›í•˜ëŠ” ë°ì´í„° íƒ€ì…ì´ ë‹¤ë¦…ë‹ˆë‹¤.
- BigQueryì—ì„œëŠ” ë¬¸ìì—´ ë°ì´í„°ë¥¼ 'STRING' íƒ€ì…ìœ¼ë¡œ ì •ì˜í•©ë‹ˆë‹¤.
- Azure SQL DatabaseëŠ” SQL Server ê¸°ë°˜ìœ¼ë¡œ, ë¬¸ìì—´ ë°ì´í„°ë¥¼ 'VARCHAR'(ASCII) ë˜ëŠ” 'NVARCHAR'(ìœ ë‹ˆì½”ë“œ) íƒ€ì…ìœ¼ë¡œ ì •ì˜í•´ì•¼ í•©ë‹ˆë‹¤.
- 'STRING' ë°ì´í„° íƒ€ì…ì€ Azure SQL Databaseì—ì„œ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

## Resolution Steps
1. schema.sql íŒŒì¼ì—ì„œ ëª¨ë“  ë¬¸ìì—´ ë°ì´í„° íƒ€ì…ì„ Azure SQL Databaseì—ì„œ ì§€ì›í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ì •ì˜:
   - ASCII ë¬¸ìì—´: VARCHAR(ê¸¸ì´) ì‚¬ìš©
   - ìœ ë‹ˆì½”ë“œ ë¬¸ìì—´(í•œê¸€ ë“±): NVARCHAR(ê¸¸ì´) ì‚¬ìš©
   - ê¸¸ì´ ì œí•œ ì—†ëŠ” í…ìŠ¤íŠ¸: NVARCHAR(MAX) ì‚¬ìš©

2. ë°ì´í„°ë² ì´ìŠ¤ ì‹œìŠ¤í…œ ê°„ ë°ì´í„° íƒ€ì… ë§¤í•‘ ê·œì¹™ ë¬¸ì„œí™”:
   - BigQuery STRING â†’ Azure SQL VARCHAR/NVARCHAR
   - BigQuery INTEGER â†’ Azure SQL INT
   - BigQuery FLOAT â†’ Azure SQL FLOAT
   - BigQuery BOOLEAN â†’ Azure SQL BIT
   - BigQuery TIMESTAMP â†’ Azure SQL DATETIME2

## Error Message / Logs
```
Msg 2715, Level 16, State 3, Line X
Column, parameter, or variable #X: Cannot find data type STRING.
```

## Related Commits or Pull Requests
- schema.sql íŒŒì¼ ìˆ˜ì •: ë°ì´í„° íƒ€ì… í˜¸í™˜ì„± í™•ë³´

## Reproduction Steps
1. Azure SQL Databaseì—ì„œ 'STRING' ë°ì´í„° íƒ€ì…ì„ ì‚¬ìš©í•˜ì—¬ í…Œì´ë¸” ìƒì„± ì‹œë„
2. ë°ì´í„° íƒ€ì… ì˜¤ë¥˜ ë°œìƒ í™•ì¸

## Prevention / Lessons Learned
- ë°ì´í„°ë² ì´ìŠ¤ ì‹œìŠ¤í…œ ê°„ ë°ì´í„° íƒ€ì… ì°¨ì´ë¥¼ ì´í•´í•˜ê³  ì ì ˆí•œ ë§¤í•‘ í•„ìš”
- ë°ì´í„° ì´ê´€ í”„ë¡œì íŠ¸ì—ì„œëŠ” ì†ŒìŠ¤ì™€ ëŒ€ìƒ ì‹œìŠ¤í…œì˜ ë°ì´í„° íƒ€ì… í˜¸í™˜ì„± í™•ì¸ í•„ìˆ˜
- Azure SQL Database(SQL Server)ëŠ” ë‹¤ìŒ ê³µì‹ ë¬¸ì„œì— ëª…ì‹œëœ ë°ì´í„° íƒ€ì…ë§Œ ì§€ì›í•¨:
  https://learn.microsoft.com/en-us/sql/t-sql/data-types/data-types-transact-sql?view=azuresqldb-current

## Related Links
- Microsoft ê³µì‹ ë¬¸ì„œ - SQL Server ë°ì´í„° íƒ€ì…: https://learn.microsoft.com/en-us/sql/t-sql/data-types/data-types-transact-sql?view=azuresqldb-current#character-strings
  (í•´ë‹¹ ë¬¸ì„œì˜ "Character strings" ì„¹ì…˜ì—ì„œ VARCHAR, NVARCHAR ë“± ë¬¸ìì—´ ë°ì´í„° íƒ€ì… í™•ì¸ ê°€ëŠ¥)
- Microsoft ê³µì‹ ë¬¸ì„œ - SQL Server ë¬¸ìì—´ ë°ì´í„° íƒ€ì…: https://learn.microsoft.com/en-us/sql/t-sql/data-types/char-and-varchar-transact-sql?view=azuresqldb-current
  (í•´ë‹¹ ë¬¸ì„œì—ì„œ VARCHAR ë°ì´í„° íƒ€ì… ìƒì„¸ ì„¤ëª… í™•ì¸ ê°€ëŠ¥)
- Microsoft ê³µì‹ ë¬¸ì„œ - SQL Server ìœ ë‹ˆì½”ë“œ ë¬¸ìì—´ ë°ì´í„° íƒ€ì…: https://learn.microsoft.com/en-us/sql/t-sql/data-types/nchar-and-nvarchar-transact-sql?view=azuresqldb-current
  (í•´ë‹¹ ë¬¸ì„œì—ì„œ NVARCHAR ë°ì´í„° íƒ€ì… ìƒì„¸ ì„¤ëª… í™•ì¸ ê°€ëŠ¥)
- BigQuery ë°ì´í„° íƒ€ì…: https://cloud.google.com/bigquery/docs/reference/standard-sql/data-types
- Azure SQL Database ë¬¸ì„œ: https://learn.microsoft.com/en-us/azure/azure-sql/database/ 